# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Обзор проекта

**Tafsir Editor** - автоматизированный редактор документов Word для книг тафсира (толкования Корана) с русско-арабским текстом.

Приложение использует классификацию блоков на основе правил для безопасной обработки смешанного текста с помощью ИИ:
- **AYAH блоки** (аяты Корана на арабском) - защищены от изменения ИИ
- **TRANSLATION блоки** (русский перевод) - можно обрабатывать ИИ
- **COMMENTARY блоки** (текст тафсира) - можно обрабатывать ИИ

## Команды

### Разработка
```bash
# Установка зависимостей
pip install -r requirements.txt

# Запуск с авто-настройкой (создает таблицы БД и запускает демо)
python main.py

# Тест подключения к базе данных
python main.py --test-connection

# Создание таблиц БД
python main.py --setup-db
```

### Обработка документов
```bash
# Классификация блоков документа (анализ определения AYAH и COMMENTARY)
python main.py --classify documents/file.docx

# ИИ-редактирование с визуальной разницей (создает копию _edited.docx)
python main.py --edit documents/file.docx

# Предпросмотр изменений ИИ без сохранения
python main.py --edit documents/file.docx --dry-run

# Ограничение обработки N блоками (для тестирования)
python main.py --edit documents/file.docx --max-blocks 5

# Обработка документа и сохранение в БД
python main.py --process documents/file.docx

# Запуск демонстрации с примером документа
python main.py --demo
```

### Управление БД
```bash
# Удаление всех таблиц (ВНИМАНИЕ: удаляет данные!)
python main.py --drop-db
```

## Архитектура

### Основные модули

**main.py** - Точка входа с CLI командами
- Авто-настройка: проверка конфига, тест подключений, создание схемы БД
- Маршрутизация команд для операций classify/edit/process
- Логирование всех операций с документами в БД

**document_processor.py** - Умный парсер документов с классификацией блоков
- `TafsirDocumentProcessor`: загрузка .docx файлов, классификация параграфов
- Enum `BlockType`: AYAH, TRANSLATION, COMMENTARY, HEADER, REFERENCE, EMPTY, UNKNOWN
- Определение скрипта через Unicode диапазоны (арабский: U+0600-U+06FF, кириллица: U+0400-U+04FF)
- Правила классификации на основе: соотношения скриптов, информации о шрифте, цвета текста, стилей
- Система защиты: AYAH блоки помечены как `can_process_with_ai=False`

**ai_editor.py** - Текстовый редактор на OpenAI с визуальной разницей
- `TafsirAIEditor`: отправляет блоки в OpenAI GPT для улучшения
- Системный промпт со строгими правилами транслитерации (латинская 'h' vs русская 'х')
- `VisualDiffWriter`: создает Word документы с:
  - СТАРЫЙ текст: красное зачеркивание
  - НОВЫЙ текст: желтое выделение
- `add_ayah_brackets()`: оборачивает арабский текст в Unicode коранические скобки ﴿﴾

**database/** - Слой БД с двойной стратегией подключения
- `connection.py`: клиент Supabase API (service role key)
- `schema.py`: прямые PostgreSQL DDL операции через psycopg2
- Таблицы: `formatting_rules`, `document_history`, `transliteration_rules`

**config.py** - Конфигурация из окружения
- Загрузка из .env файла (не коммитится в git)
- Обязательные: SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, DATABASE_URL
- Опциональные: OPENAI_API_KEY (для ИИ редактирования), OPENAI_MODEL (по умолчанию: gpt-4o-mini)

### Поток данных

1. **Загрузка документа**: `TafsirDocumentProcessor.load()` читает .docx файл
2. **Классификация**: каждый параграф анализируется по типу скрипта, шрифту, цвету
3. **Создание блоков**: объекты `TafsirBlock` с метаданными и флагом допуска к ИИ
4. **ИИ обработка**: только TRANSLATION и COMMENTARY блоки отправляются в OpenAI
5. **Визуальная разница**: изменения применяются к Word документу с форматированием
6. **Логирование в БД**: все операции записываются в таблицу `document_history`

### Правила классификации блоков

Классификатор использует логику на правилах (не ML) в `_detect_block_type()`:

- **Определение AYAH**:
  - Чистый арабский (>90%) + красный цвет текста
  - Чистый арабский (>90%) + название арабского шрифта
  - Очень высокое соотношение арабского (>95%)
  - Высокое соотношение арабского (>80%) + название шрифта содержит "arabic"

- **Определение TRANSLATION**:
  - Чистая кириллица, умеренная длина (<500 символов)

- **Определение COMMENTARY**:
  - Доминирующий кириллический текст (соотношение арабского <30%)
  - Смешанный текст с кириллическим большинством (соотношение арабского <50%)

### Правила системного промпта ИИ

Находятся в `ai_editor.py:get_system_prompt()`, обеспечивают:
- Строгая транслитерация: латинская 'h' для ه, русская 'х' для ح
- Обработка религиозных терминов: Аллаh (с латинской h), сохранение символа ﷺ
- Никаких теологических изменений, никаких модификаций арабских слов
- Возврат неизмененного текста, если уже корректен

## Настройка окружения

Создайте файл `.env`:
```
# Supabase
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJhbGc...

# PostgreSQL (прямое подключение для DDL)
DATABASE_URL=postgresql://postgres:password@db.xxx.supabase.co:5432/postgres

# OpenAI (опционально, для ИИ редактирования)
OPENAI_API_KEY=sk-...
OPENAI_MODEL=gpt-4o-mini

# Путь к документам
DOCUMENTS_PATH=./documents
```

## Схема БД

**formatting_rules** - Настройки шрифтов и стилей параграфов
- Названия и размеры шрифтов для арабского/кириллицы
- Межстрочный интервал, выравнивание, RTL направление
- Флаг активности/неактивности для наборов правил

**document_history** - Журнал аудита всех операций с документами
- Название документа, путь, тип действия
- JSON поле для гибких деталей изменений
- Статистика: затронутые параграфы, измененные символы
- Временные метки для отслеживания

**transliteration_rules** - Маппинги преобразования кириллица ↔ арабский
- Пары паттернов с контекстными правилами
- Система приоритетов для применения правил
- Примеры и заметки для каждого правила

## Важные замечания

- **Двойная стратегия подключения к БД**: psycopg2 для DDL (CREATE TABLE), Supabase API для DML (INSERT/SELECT)
- **AYAH блоки священны**: классификатор НЕ ДОЛЖЕН помечать коранические аяты как доступные для ИИ
- **Визуальная разница неразрушающая**: оригинальный текст сохраняется с зачеркиванием, можно вручную принять/отклонить
- **Правила транслитерации строгие**: различие между латинской 'h' и русской 'х' критично для правильной романизации арабского
- **Нет .env в git**: учетные данные загружаются из окружения, никогда не коммитятся
- **Русский интерфейс**: все UI сообщения, комментарии и строки документации на русском там, где обращено к пользователю
